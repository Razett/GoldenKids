<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>견적 등록</title>
    <style>
        input[type="text"], select {
            font-size: 15px;
            padding: 6px;
            width: 400px;
        }
        #loadCompanyInfo, #loadMaterialInfo {
            font-size: 15px;
            padding: 6px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<form id="quotationForm" enctype="multipart/form-data">
    <header><h1>견적등록</h1></header>
    <div>
        회사명
        <input type="text" name="contractorName" id="contractorName" placeholder="회사명을 입력하시오">
        <button type="button" id="loadCompanyInfo">불러오기</button>
    </div>
    <br>
    <fieldset>
        <div>
            사업자 등록번호 <input type="text" name="corno" placeholder="자동작성" readonly>
        </div>
        <br>
        <div>
            주소 <input type="text" name="address" placeholder="자동작성" readonly>
        </div>
        <br>
        <div>
            전화번호 <input type="text" name="phone" placeholder="자동작성" readonly>
        </div>
        <br>
        <div>
            담당자 성명 <input type="text" name="mngrName" placeholder="자동작성" readonly>
        </div>
        <br>
        <div>
            연락처 <input type="text" name="mngrPhone" placeholder="자동작성" readonly>
        </div>
        <br>
        <div>
            이메일 <input type="text" name="mngrAddress" placeholder="자동작성" readonly>
        </div>
        <br>
    </fieldset>
    <div>
        견적제목 <input type="text" name="title" placeholder="title">
    </div>
    <br>
    <div>
        견적내용 <input type="text" name="content" placeholder="content">
    </div>
    <br>
    <div>
        자재코드 <input type="text" name="materialCode" id="materialCode" placeholder="MA0001">
        <button type="button" id="loadMaterialInfo">불러오기</button>
    </div>
    <div>
        <br> <input type="text" name="materialDetails" id="materialDetails" placeholder="자재명, 재고수량, 규격, 창고명" readonly>
    </div>
    <br>
    <div>
        수량 <input type="text" name="quantity" placeholder="숫자만 입력하시오 ex) 1">
    </div>
    <br>
    <div>
        단가 <input type="text" name="unitPrice" placeholder="숫자만 입력하시오">
    </div>
    <br>
    <div>
        총금액 <input type="text" name="totalPrice" placeholder="숫자만 입력하시오">
    </div>
    <br>
    <div>
        L/T <input type="text" name="leadTime" placeholder="ex) 20240716">
    </div>
    <br>
    <div>
        견적서 파일 <input type="file" name="file" multiple>
    </div>
    <br>
    <!-- Hidden input for empNo -->
    <input type="hidden" name="empno" id="empno" value="201758030">

    <button type="button" id="cancel">취소</button>
    <input type="submit" value="등록하기">
</form>

<script>

    const server_url = 'http://192.168.1.25:8081'

    $(document).ready(function () {

        $('#loadCompanyInfo').click(function () {
            var contractorName = $('#contractorName').val();
            if (contractorName) {
                $.ajax({
                    url: '/contractor/getContractorDetailsByName',
                    type: 'GET',
                    data: { contractorName: contractorName },
                    success: function(data) {
                        $('input[name="corno"]').val(data.corno);
                        $('input[name="address"]').val(data.address1 + ' ' + (data.address2 || ''));
                        $('input[name="phone"]').val(data.phone);
                        $('input[name="mngrName"]').val(data.mngrName);
                        $('input[name="mngrPhone"]').val(data.mngrPhone);
                        $('input[name="mngrAddress"]').val(data.mngrAddress);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Failed to fetch contractor details:', textStatus, errorThrown);
                        alert('회사 정보를 불러오는데 실패했습니다.');
                    }
                });
            } else {
                alert('회사명을 입력해주세요.');
            }
        });

        $('#loadMaterialInfo').click(function () {
            var materialCode = $('#materialCode').val();
            if (materialCode) {
                $.ajax({
                    url: '/rest/material/details',
                    type: 'GET',
                    data: { mtrlno: materialCode },
                    success: function(data) {
                        if (data) {
                            $('#materialDetails').val(data.name + ', ' + data.quantity + ', ' + data.standard + ', ' + data.materialWarehouse.name);
                        } else {
                            alert('자재 정보를 찾을 수 없습니다.');
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Failed to fetch material details:', textStatus, errorThrown);
                        alert('자재 정보를 불러오는데 실패했습니다.');
                    }
                });
            } else {
                alert('자재코드를 입력해주세요.');
            }
        });

        $('#quotationForm').submit(function (event) {
            event.preventDefault();

            var quotationData = {
                title: $('input[name="title"]').val(),
                content: $('input[name="content"]').val(),
                status: 0,
                contractor: {
                    corno: $('input[name="corno"]').val() // 사업자 등록번호
                },
                emp: {
                    empno: $('input[name="empno"]').val() // 사원 번호
                }
            };
            $.ajax({
                url: 'http://localhost:8080/quotation/save',
                type: 'POST',
                data: JSON.stringify(quotationData),
                contentType: 'application/json',
                success: function(response) {
                    var quotationId = response; // 서버로부터 받은 견적서 ID
                    uploadFilesWithQuotationId(quotationId); // 파일 업로드 함수 호출

                    // QuotationMtrl 정보 저장
                    var materialId = $('#materialCode').val();
                    // var materialId = getMaterialIdByCode(materialCode); // 자재 코드로 자재 ID 가져오기

                    // QuotationMtrl 정보 저장
                    var quotationMtrlData = {
                        quotationId: quotationId,
                        materialId: materialId, // 서버에서 가져온 자재 ID
                        quantity: $('input[name="quantity"]').val(), // 수량
                        unitprice: $('input[name="unitPrice"]').val(), // 단가
                        totalprice: $('input[name="totalPrice"]').val(), // 총금액
                        leadtime: $('input[name="leadTime"]').val() // L/T
                    };
                    saveQuotationMtrl(quotationMtrlData);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('견적서 저장 실패:', textStatus, errorThrown);
                    alert('견적서 저장에 실패했습니다.');
                }
            });
        });

        function uploadFilesWithQuotationId(quotationId) {
            var fileData = new FormData();
            var files = $('input[name="file"]')[0].files;

            for (var i = 0; i < files.length; i++) {
                fileData.append('file', files[i]);
            }
            // fileData.append("qtno", quotationId); // `qtno`를 파일 데이터에 추가
            $.ajax({
                url: server_url + '/uploadFile',
                type: 'POST',
                data: fileData,
                processData: false,
                contentType: false,
                success: function(response) {
                   var metadata = {
                        name: response.name,
                        url: response.url,
                        uuid: response.uuid,
                        qtno: quotationId
                   };
                   sendFileMetadataToMainServer(metadata);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('파일 업로드 실패:', textStatus, errorThrown);
                    alert('파일 업로드에 실패했습니다.');
                }
            });
        }
         function sendFileMetadataToMainServer(metadata) {
            $.ajax({
                url: 'http://localhost:8080/quotationFile/save',
                type: 'POST',
                data: JSON.stringify(metadata),
                contentType: 'application/json',
                success: function(response) {
                    window.location.href = '/contractor/quolist';
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('파일 메타데이터 저장 실패:', textStatus, errorThrown);
                    alert('파일 메타데이터 저장에 실패했습니다.');
                }
            });
        }
        function saveQuotationMtrl(quotationMtrlData) {
            $.ajax({
                url: 'http://localhost:8080/quotationMtrl/save',
                type: 'POST',
                data: JSON.stringify(quotationMtrlData),
                contentType: 'application/json',
                success: function(response) {
                    console.log('견적 자재 정보 저장 성공:', response);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('견적 자재 정보 저장 실패:', textStatus, errorThrown);
                }
            });
        }


    });
</script>

</body>
</html>
